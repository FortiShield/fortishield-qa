- hosts: Agent*
  become: true
  vars:
    path: "/tmp"
    test_directory: "tests"
    test_file: "test_basic_info"
    curl_path: /usr/bin/curl

  tasks:
    - name: Test basic info
      environment:
        TINYBIRD_URL: "{{ tinybird_url|quote }}"  # depends on your region
        TINYBIRD_DATASOURCE: "{{ tinybird_datasource|quote }}"  # will be created with first results posted
        TINYBIRD_TOKEN: "{{ tinybird_token|quote }}"
      block:
        - name: Execute tests
          command: "pytest {{ test_file }}.py --to_version={{ version|quote }} --revision={{ revision|quote }} -vl --tb=short --influxdb-report"
          args:
            chdir: "{{ path }}/{{ test_directory }}"
          register: pytest_log

      always:
        - name: Save pytest output to a file
          copy:
            remote_src: yes
            content: "{{ pytest_log.stdout }}"
            dest: "{{ path }}/{{ test_directory }}/{{ test_file }}.log"
