- name: Install dependencies
  {% if ansible_os_family == 'Debian' %}
  apt:
    name:
      - "build-essential"
      - "libreadline-dev"
      - "libncursesw5-dev"
      - "libssl-dev"
      - "libsqlite3-dev"
      - "libgdbm-dev"
      - "libc6-dev"
      - "libbz2-dev"
      - "libffi-dev"
      - "zlib1g-dev"
    state: present
  {% endif %}
  {% if ansible_os_family == 'RedHat' %}
  yum:
    name:
      - "Development Tools"
      - "zlib-devel"
    state: present
  {% endif %}

- name: Download and extract Python {{ python_version }}
  get_url:
    url: "https://www.python.org/ftp/python/{{ python_version }}/Python-{{ python_version }}.tgz"
    dest: "/tmp/Python-{{ python_version }}.tgz"
    mode: 0755
  register: download_python

- name: Extract Python {{ python_version }}
  unarchive:
    src: "/tmp/Python-{{ python_version }}.tgz"
    dest: "/tmp"
    remote_src: yes
  when: download_python.changed

- name: Install Python {{ python_version }}
  shell: |
    cd /tmp/Python-{{ python_version }} && ./configure --enable-optimizations && make altinstall
  args:
    chdir: "/tmp/Python-{{ python_version }}"
  when: download_python.changed
  register: install_python

- name: Set default python to {{ python_version }}
  shell: |
    update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python{{ python_version }} 1
    update-alternatives --install /usr/bin/pip3 pip3 /usr/local/bin/pip{{ python_version }} 1
  when: install_python.changed