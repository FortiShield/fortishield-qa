import re

from wazuh_testing.modules import vulnerability_detector as vd
from wazuh_testing.modules.vulnerability_detector import event_monitor as evm
from wazuh_testing.db_interface.cve_db import get_provider_feeds_number
from wazuh_testing.tools import ALERT_FILE_PATH
from wazuh_testing.tools.monitoring import FileMonitor


def check_vuln_detector_alert(wazuh_alert_monitor=None, callback='', error_message=None, update_position=True,
                              timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT,
                              prefix=vd.VULNERABILITY_DETECTOR_PREFIX, accum_results=1):
    """Check if a vulnerability event occurs

    Args:
        wazuh_alert_monitor (FileMonitor): FileMonitor object to monitor the alert json
        callback (str): log regex to check in Wazuh log
        error_message (str): error message to show in case of expected event does not occur
        update_position (boolean): filter configuration parameter to search in Wazuh log
        timeout (str): timeout to check the event in Wazuh log
        prefix (str): log pattern regex
        accum_results (int): Accumulation of matches.
    """
    wazuh_alert_monitor = FileMonitor(ALERT_FILE_PATH) if wazuh_alert_monitor is None else wazuh_alert_monitor
    error_message = f"Could not find this alert in {ALERT_FILE_PATH}: {callback}" if error_message is None else \
        error_message

    wazuh_alert_monitor.start(timeout=timeout, update_position=update_position, accum_results=accum_results,
                              callback=evm.make_vuln_callback(callback, prefix), error_message=error_message)


def check_removal_package_alert(test_packet_cve, test_packet_name):
    """Check that the package eliminated message is logged correctly.

    Args:
        test_packet_cve (str): Vulnerability name.
        test_packet_name (str): Package name.
    """
    check_vuln_detector_alert(
                timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT,
                callback=f"{test_packet_cve} affecting {test_packet_name} was eliminated",
                error_message=f"ERROR: No alert for '{test_packet_name}' has been detected in the log.",
                prefix=r".*")
