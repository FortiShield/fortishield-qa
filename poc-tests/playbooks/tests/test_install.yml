- hosts: all
  become: true
  vars:
    path: "/tmp"
    test_directory: "tests"
    test_install_file: "test_install.py"
    curl_path: /usr/bin/curl

  tasks:
    - name: Download dist-detect.sh
      command: "{{ curl_path }} -kL http://raw.githubusercontent.com/wazuh/wazuh/{{ branch_version }}/src/init/dist-detect.sh -o {{ path }}/dist-detect.sh"

    - name: Get operating system name
      shell: ". {{ path }}/dist-detect.sh && echo $DIST_NAME $DIST_VER"
      register: os
      args:
        executable: /bin/bash

    - name: Get Wazuh target
      shell: "/var/ossec/bin/wazuh-control info | grep -E -o 'agent|server'"
      register: target

    - name: Run tests on wazuh-agent
      command: "pytest {{ test_install_file }} --to_version={{ version|quote }} --os={{ os.stdout|quote }} --target={{ target.stdout|quote }} -v"
      args:
        chdir: "{{ path }}/{{ test_directory }}"
      when: target.stdout == 'agent'

    - name: Run tests on wazuh-manager
      command: "pytest {{ test_install_file }} --to_version={{ version|quote }} --os={{ os.stdout|quote }} --target={{ target.stdout|quote }} -v"
      args:
        chdir: "{{ path }}/{{ test_directory }}"
      when: target.stdout == 'server'
