- hosts: all
  become: true
  vars:
    path: "/tmp"
    test_directory: "tests"
    test_file: "test_install.py"
    curl_path: /usr/bin/curl

  tasks:
    - name: Download dist-detect.sh
      command: "{{ curl_path }} -kL http://raw.githubusercontent.com/wazuh/wazuh/{{ branch_version }}/src/init/dist-detect.sh -o {{ path }}/dist-detect.sh"

    - name: Get operating system name
      shell: ". {{ path }}/dist-detect.sh && echo $DIST_NAME $DIST_VER"
      register: os
      args:
        executable: /bin/bash

    - name: Test install
      block:
        - name: Execute tests
          command: "pytest {{ test_file }} --to_version={{ version|quote }} --os={{ os.stdout|quote }} --target={{ target }} -vl"
          args:
            chdir: "{{ path }}/{{ test_directory }}"
          vars:
            target: "{% if 'Agent' in inventory_hostname %}agent{% elif 'Manager' in inventory_hostname %}server{% endif %}"
          register: pytest_log

      always:
        - name: Save pytest output to a file
          copy:
            remote_src: yes
            content: "{{ pytest_log.stdout }}"
            dest: "{{ path }}/{{ test_directory }}/{{ test_file }}.log"
