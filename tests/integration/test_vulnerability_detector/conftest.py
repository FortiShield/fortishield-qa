# Copyright (C) 2015-2021, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

from subprocess import CalledProcessError

import pytest
from wazuh_testing.tools import LOG_FILE_PATH
from wazuh_testing.tools.file import truncate_file
from wazuh_testing.tools.monitoring import FileMonitor
from wazuh_testing.tools.services import control_service
from wazuh_testing import vulnerability_detector as vd


@pytest.fixture(scope='module')
def restart_modulesd(get_configuration, request):
    # Reset ossec.log and start a new monitor
    control_service('stop', daemon='wazuh-modulesd')
    truncate_file(LOG_FILE_PATH)
    file_monitor = FileMonitor(LOG_FILE_PATH)
    setattr(request.module, 'wazuh_log_monitor', file_monitor)
    try:
        control_service('start', daemon='wazuh-modulesd')
    except ValueError:
        pass


@pytest.fixture(scope='module')
def clean_vuln_tables(request):
    """ Clean vulnerabilities tables """
    vd.clean_vd_tables()

    yield

    vd.clean_vd_tables()


@pytest.fixture
def restart_modulesd_catching_ossec_conf_error(request):
    control_service('stop', daemon='wazuh-modulesd')
    truncate_file(LOG_FILE_PATH)
    file_monitor = FileMonitor(LOG_FILE_PATH)
    setattr(request.module, 'wazuh_log_monitor', file_monitor)
    try:
        control_service('start', daemon='wazuh-modulesd')
    except (ValueError, CalledProcessError):
        pass


@pytest.fixture(scope='session')
def mock_agent():
    control_service('stop', daemon='wazuh-db')

    agent_id = vd.create_mocked_agent(name="mocked_agent")

    control_service('start', daemon='wazuh-db')

    yield agent_id

    control_service('stop', daemon='wazuh-db')

    vd.delete_mocked_agent(agent_id)

    control_service('start', daemon='wazuh-db')
