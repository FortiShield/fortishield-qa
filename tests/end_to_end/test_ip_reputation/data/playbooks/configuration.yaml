- name: Test manager configuration
  hosts: wazuh-manager
  become: true
  tasks:

    - name: Install apache
      become: true
      shell: yum install httpd -y

    - name: Start apache
      become: true
      shell: systemctl start httpd

    - name: Install pyhton
      become: true
      shell: yum install python39 -y

    - name: Download Alienvault IP
      become: true
      shell: >
        wget https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/alienvault_reputation.ipset
        -O /var/ossec/etc/lists/alienvault_reputation.ipset

    - name: Download script to convert from ipset format to cdblist format
      become: true
      shell: wget https://wazuh.com/resources/iplist-to-cdblist.py -O /tmp/iplist-to-cdblist.py

    - name: Add the attacker IP to the list
      become: true
      shell: echo "{{ hostvars['wazuh-windows']['ip_address'] }}" >> /var/ossec/etc/lists/alienvault_reputation.ipset

    - name: Convert .ipset to .cdb using script
      become: true
      shell: >
        python3 /tmp/iplist-to-cdblist.py /var/ossec/etc/lists/alienvault_reputation.ipset
        /var/ossec/etc/lists/blacklist-alienvault

    - name: Remove the .ipset file and the script
      become: true
      shell: |
        rm -rf /var/ossec/etc/lists/alienvault_reputation.ipset
        rm -rf /var/ossec/etc/lists/iplist-to-cdblist.py

    - name: Assign the right permissions and owner to the file
      become: true
      shell: |
        chown wazuh:wazuh /var/ossec/etc/lists/blacklist-alienvault
        chmod 660 /var/ossec/etc/lists/blacklist-alienvault

    - name: Configure ossec.conf
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: </ossec_config>
        block: |
          <localfile>
          <log_format>apache</log_format>
          <location>/var/log/httpd/access_log</location>
          </localfile>
          <ruleset>
          <!-- Default ruleset -->
          <decoder_dir>ruleset/decoders</decoder_dir>
          <rule_dir>ruleset/rules</rule_dir>
          <rule_exclude>0215-policy_rules.xml</rule_exclude>
          <list>etc/lists/audit-keys</list>
          <list>etc/lists/blacklist-alienvault</list>
          <!-- User-defined ruleset -->
          <decoder_dir>etc/decoders</decoder_dir>
          <rule_dir>etc/rules</rule_dir>
          </ruleset>

          <command>
          <name>firewall-drop</name>
          <executable>firewall-drop</executable>
          <timeout_allowed>yes</timeout_allowed>
          </command>

          <active-response>
          <command>firewall-drop</command>
          <location>server</location>
          <rules_id>100100</rules_id>
          <timeout>10s</timeout>
          </active-response>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Configure local rules
      become: true
      blockinfile:
        path: /var/ossec/etc/rules/local_rules.xml
        insertafter: </groups>
        block: |
          <group name="attack,">
          <rule id="100100" level="10">
          <if_group>web|attack|attacks</if_group>
          <list field="srcip" lookup="address_match_key">etc/lists/blacklist-alienvault</list>
          <description>IP address found in AlienVault reputation database.</description>
          </rule>
          </group>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Restart the manager
      become: true
      shell: systemctl restart wazuh-manager

- name: Windows agent configuration
  hosts: wazuh-windows
  tasks:

    - name: Add hostname to hosts file
      win_lineinfile:
        path: C:\Windows\System32\drivers\etc\hosts
        line: |
          {{ hostvars['wazuh-manager']['ip_address'] }} wazuh-manager
