- name: Configure environment
  hosts: wazuh-manager
  become: true
  tasks:

    - name: Configure the aws-s3 wodle
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->
        insertbefore: ^</ossec_config>
        block: |
          <wodle name="aws-s3">
          <disabled>no</disabled>
          <remove_from_bucket>no</remove_from_bucket>
          <interval>10s</interval>
          <run_on_start>yes</run_on_start>
          <skip_on_error>no</skip_on_error>
          <bucket type="cloudtrail">
          <name>{{ bucket_name }}</name>
          <access_key>{{ aws_access_key_id }}</access_key>
          <secret_key>{{ aws_secret_access_key }}</secret_key>
          <only_logs_after>{{ date }}</only_logs_after>
          <regions>{{ aws_region }}</regions>
          </bucket>
          </wodle>

    - name: Restart wazuh-manager
      systemd:
        state: restarted
        name: wazuh-manager

    - name: Copy the script to send a request to the AWS API
      copy:
        src: "{{ aws_s3_script }}"
        dest: /tmp
        mode: '0710'

    - name: Check if python3 is installed
      shell: python3.8 --version
      ignore_errors: true
      register: python_check

    - name: Install python v3.8.7
      shell: |
        yum -y update
        yum -y install wget make gcc openssl-devel bzip2-devel
        wget https://www.python.org/ftp/python/3.8.7/Python-3.8.7.tgz
        tar xzf Python-3.8.7.tgz
        cd Python-3.8.7
        ./configure --enable-optimizations
        make altinstall
        ln -sfn /usr/local/bin/python3.8 /usr/bin/python3.8
        ln -sfn /usr/local/bin/pip3.8 /usr/bin/pip3.8
      # Do not install python3 if it is already installed
      when: python_check is failed

    - name: Install boto3 python package (script dependency)
      shell: python3.8 -m pip install boto3
