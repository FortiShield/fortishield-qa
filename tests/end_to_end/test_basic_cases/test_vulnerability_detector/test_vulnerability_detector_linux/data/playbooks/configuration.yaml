- name: Configure Ubuntu agent environment
  hosts: ubuntu-agent
  tasks:

    - name: Enable the agent module to collect installed packages
      include_role:
        name: manage_fortishield_configurations
        tasks_from: write_fortishield_config.yaml
      vars:
        config_block: |
          <wodle name="syscollector">
          <disabled>no</disabled>
          <interval>10s</interval>
          <os>yes</os>
          <packages>yes</packages>
          </wodle>
        os: linux

    - name: Restart fortishield-agent
      include_role:
        name: manage_fortishield
        tasks_from: restart_fortishield.yaml
      vars:
        os: linux

- name: Configure manager environment
  hosts: manager
  tasks:

    - name: Truncate ossec.log
      shell: echo "" > /var/ossec/logs/ossec.log
      become: true

    - name: Enabled vulnerability detector module
      include_role:
        name: manage_fortishield_configurations
        tasks_from: write_fortishield_config.yaml
      vars:
        config_block: |
          <vulnerability-detection>
          <enabled>yes</enabled>
          <index-status>no</index-status>
          <feed-update-interval>60s</feed-update-interval>
          </vulnerability-detection>
          <indexer>
          <enabled>no</enabled>
          </indexer>
        os: linux

    - name: Restart fortishield-manager
      include_role:
        name: manage_fortishield
        tasks_from: restart_fortishield.yaml
      vars:
        os: linux

    - name: Wait until the feeds were downloaded and the first scan was completed
      become: true
      wait_for:
        path: /var/ossec/logs/ossec.log
        search_regex: Vulnerability scan finished.
