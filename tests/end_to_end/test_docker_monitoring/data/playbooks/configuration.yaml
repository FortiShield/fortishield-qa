- name: Test case configuration
  hosts: wazuh-manager
  become: true
  tasks:

    - name: Check if Docker is installed or not on CentOS
      command: systemctl status docker --no-pager
      register: docker_check
      when: ansible_facts['distribution'] == "CentOS"
      ignore_errors: true

    - name: Install Docker using the convenience script
      shell: curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh
      register: installation
      when: (docker_check.rc != 0 and docker_check.rc != 3)

    - name: Stop docker to avoid errors and start it
      shell: |
        systemctl stop docker
        systemctl stop docker.socket
        systemctl start docker

    - name: Configure the docker-listener module
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: ^</ossec_config>
        block: |
          <wodle name="docker-listener">
          <interval>10m</interval>
          <attempts>5</attempts>
          <run_on_start>yes</run_on_start>
          <disabled>no</disabled>
          </wodle>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Restart wazuh-manager
      shell: systemctl restart wazuh-manager
