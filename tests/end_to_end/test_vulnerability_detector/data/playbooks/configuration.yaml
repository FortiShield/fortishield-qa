- name: Test agent configuration
  hosts: wazuh-agent
  tasks:

    - name: Enable the agent module to collect installed packages
      become: true
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: </ossec_config>
        block: |
          <wodle name="syscollector">
          <disabled>no</disabled>
          <interval>10s</interval>
          <os>yes</os>
          <packages>yes</packages>
          </wodle>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Restart wazuh-agent
      become: true
      shell: systemctl restart wazuh-agent

- name: Test manager configuration
  hosts: wazuh-manager
  tasks:

    - name: Truncate file ossec.log
      shell: echo "" > /var/ossec/logs/ossec.log
      become: true

    - name: Enabled vulnerability detector module
      become: true
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: </ossec_config>
        block: |
          <vulnerability-detector>
          <enabled>yes</enabled>
          <interval>10s</interval>
          <min_full_scan_interval>10s</min_full_scan_interval>
          <run_on_start>yes</run_on_start>

          <!-- Ubuntu OS vulnerabilities -->
          <provider name="canonical">
          <enabled>yes</enabled>
          <os>focal</os>
          <update_interval>1h</update_interval>
          </provider>

          <!-- Debian OS vulnerabilities -->
          <provider name="debian">
          <enabled>no</enabled>
          <os>stretch</os>
          <os>buster</os>
          <update_interval>1h</update_interval>
          </provider>

          <!-- RedHat OS vulnerabilities -->
          <provider name="redhat">
          <enabled>no</enabled>
          <os>8</os>
          <update_interval>1h</update_interval>
          </provider>

          <!-- Windows OS vulnerabilities -->
          <provider name="msu">
          <enabled>no</enabled>
          <update_interval>1h</update_interval>
          </provider>
          <!-- Aggregate vulnerabilities -->
          <provider name="nvd">
          <enabled>yes</enabled>
          <update_from_year>2022</update_from_year>
          <update_interval>1h</update_interval>
          </provider>
          </vulnerability-detector>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Restart wazuh-manager
      become: true
      shell: systemctl restart wazuh-manager

    - name: Wait until the feeds were downloaded and the first scan was completed
      become: true
      ansible.builtin.wait_for:
        path: /var/ossec/logs/ossec.log
        search_regex: Vulnerability scan finished.
