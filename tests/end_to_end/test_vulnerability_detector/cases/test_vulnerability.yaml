- case: "Installation of a vulnerable package"
  id: "install_package"
  description: "Installation of a vulnerable package"
  preconditions: null
  body:
    tasks:
      - operation: install_package
        target: agent
        package:
          centos:
            amd64: https://nmap.org/dist/nmap-6.46-1.x86_64.rpm
            arm64v8: [https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-libs-11.17-2PGDG.rhel7.aarch64.rpm, https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-11.17-2PGDG.rhel7.aarch64.rpm]
          ubuntu:
            amd64: https://dl.grafana.com/enterprise/release/grafana-enterprise_8.5.5_amd64.deb
            arm64v8: https://dl.grafana.com/enterprise/release/grafana-enterprise_8.5.5_arm64.deb
          windows:
            amd64: https://get.videolan.org/vlc/3.0.6/win64/vlc-3.0.6-win64.exe
          macos:
            amd64: https://nodejs.org/dist/v17.0.1/node-v17.0.1.pkg

      - operation: check_agent_vulnerability
        target: agent
        parameters:
          alert_indexed: False
          api: True
          alert: False
          state_indice: False
        vulnerability_data:
          centos:
            amd64:
                - PACKAGE_NAME: "nmap"
                  PACKAGE_VERSION: "6.46-1"
                  CVE: CVE-2018-15173
            arm64v8:
                - PACKAGE_NAME: "postgresql11"
                  PACKAGE_VERSION: "11.17.2"
                  CVE: CVE-2023-39417
          ubuntu:
            amd64:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "8.5.5"
                  CVE: CVE-2023-2183
            arm64v8:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "8.5.5"
                  CVE: CVE-2023-2183
          windows:
            amd64:
                - PACKAGE_NAME: "vlc"
                  PACKAGE_VERSION: "3.0.6"
                  CVE: CVE-2023-47360
          macos:
            amd64:
                - PACKAGE_NAME: "node"
                  PACKAGE_VERSION: "17.0.1"
                  CVE: CVE-2022-21824
  # teardown:
  #   tasks:
  #     - operation: remove_package
  #       target: agent
  #       package:
  #         centos:
  #           amd64: rclone
  #           arm64v8: postgresql11*
  #         ubuntu:
  #           amd64: grafana*
  #           arm64v8: grafana*
  #         windows:
  #           amd64: vlc
  #         macos:
  #           amd64: node*

# ----------------------------------------------------------------------------------

- case: "Updating a vulnerable package that remains vulnerable to the same CVE"
  id: "update_vuln_package_vuln_remain"
  description: "Updating a vulnerable package that remains vulnerable to the same CVE"
  preconditions: null
  body:
    tasks:
      - operation: install_package
        target: agent
        package:
          centos:
            amd64: https://nmap.org/dist/nmap-6.47-1.x86_64.rpm
            arm64v8: [https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-libs-11.18-2PGDG.rhel7.aarch64.rpm, https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-11.18-1PGDG.rhel7.aarch64.rpm]
          ubuntu:
            amd64: https://dl.grafana.com/enterprise/release/grafana-enterprise_8.5.6_amd64.deb
            arm64v8: https://dl.grafana.com/enterprise/release/grafana-enterprise_8.5.6_arm64.deb
          windows:
            amd64: https://get.videolan.org/vlc/3.0.8/win64/vlc-3.0.8-win64.exe
          macos:
            amd64: https://nodejs.org/dist/v17.1.0/node-v17.1.0.pkg
      - operation: check_agent_vulnerability
        target: agent
        parameters:
          alert_indexed: False
          api: True
          alert: False
          state_indice: False
        vulnerability_data:
          centos:
            amd64:
                - PACKAGE_NAME: "nmap"
                  PACKAGE_VERSION: "6.47-1"
                  CVE: CVE-2020-28924
            arm64v8:
                - PACKAGE_NAME: "postgresql11"
                  PACKAGE_VERSION: "11.17.2"
                  CVE: CVE-2023-39417
          ubuntu:
            amd64:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "8.5.6"
                  CVE: CVE-2023-2183
            arm64v8:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "8.5.6"
                  CVE: CVE-2023-2183
          windows:
            amd64:
                - PACKAGE_NAME: "vlc"
                  PACKAGE_VERSION: "3.0.8"
                  CVE: CVE-2023-47360
          macos:
            amd64:
                - PACKAGE_NAME: "node"
                  PACKAGE_VERSION: "17.1.0"
                  CVE: CVE-2022-21824
  teardown:
    tasks:
      - operation: remove_package
        target: agent
        package:
          windows:
            amd64: vlc

# ---------------------------------------------------------------------

- case: "Updating a vulnerable package that becomes vulnerable to another CVE"
  id: "updating_vulnerable_package_another_cve"
  description: "Updating a vulnerable package that becomes vulnerable to another CVE"
  preconditions:
      tasks:
      - operation: install_package
        target: agent
        package:
          windows:
            amd64: https://get.videolan.org/vlc/3.0.7/win32/vlc-3.0.7-win32.exe
      - operation: check_agent_vulnerability
        target: agent
        parameters:
          alert_indexed: False
          api: True
          alert: False
          state_indice: False
        vulnerability_data:
          windows:
            amd64:
                - PACKAGE_NAME: "vlc"
                  PACKAGE_VERSION: "3.0.8"
                  CVE: CVE-2023-47360
  body:
    tasks:
      - operation: install_package
        target: agent
        package:
          centos:
            amd64: https://nmap.org/dist/nmap-7.00-1.x86_64.rpm
            arm64v8: [https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-libs-11.20-1PGDG.rhel7.aarch64.rpm, https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-aarch64/postgresql11-11.20-1PGDG.rhel7.aarch64.rpm]
          ubuntu:
            amd64: https://dl.grafana.com/enterprise/release/grafana-enterprise_9.1.1_amd64.deb
            arm64v8: https://dl.grafana.com/enterprise/release/grafana-enterprise_9.1.1_arm64.deb
          windows:
            amd64: https://get.videolan.org/vlc/3.0.7.1/win64/vlc-3.0.7.1-win64.exe
          macos:
            amd64: https://nodejs.org/dist/v18.0.0/node-v18.0.0.pkg
      - operation: check_agent_vulnerability
        target: agent
        parameters:
          alert_indexed: False
          api: True
          alert: False
          state_indice: False
        vulnerability_data:
          centos:
            amd64:
                # Wrong package
                - PACKAGE_NAME: "nmap"
                  PACKAGE_VERSION: "7.00"
                  CVE: CVE-2020-28924
                - PACKAGE_NAME: "nmap"
                  PACKAGE_VERSION: "7.00"
                  CVE: CVE-2018-1000161
            arm64v8:
                - PACKAGE_NAME: "postgresql11"
                  PACKAGE_VERSION: "11.20"
                  CVE: CVE-2023-39417
          ubuntu:
            amd64:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "9.1.1"
                  CVE: CVE-2023-1387
            arm64v8:
                - PACKAGE_NAME: "grafana"
                  PACKAGE_VERSION: "9.1.1"
                  CVE: CVE-2023-1387
          windows:
            amd64:
                - PACKAGE_NAME: "vlc"
                  PACKAGE_VERSION: "3.0.7"
                  CVE: CVE-2019-13962
                  STATUS: ABSENT
                - PACKAGE_NAME: "vlc"
                  PACKAGE_VERSION: "3.0.7.1"
                  CVE: CVE-2019-14437
          # Wrong package
          macos:
            amd64:
                - PACKAGE_NAME: "node"
                  PACKAGE_VERSION: "17.1.0"
                  CVE: CVE-2022-21824

# -----------------------------------------------------------