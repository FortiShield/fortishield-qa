# REQUIRED VARIABLES
# -------------------
# (String) os: Target operating system

- name: Get Wazuh installation
  include_role:
    name: service_controller
    tasks_from: get_installation_type

- name: Test connection with host
  shell: nc -v -4 {{ inventory_hostname }} 9200
  timeout: 3
  ignore_errors: true
  register: test_result
  delegate_to: localhost
  when: (os == 'Linux' and 'server' in wazuh_info.stdout)

- name: Check the connection between Controller node and Wazuh Indexer
  set_fact:
    failed: true
    errors: "{{ errors }}\nAnsible Controller node cannot connect correctly with Wazuh Indexer."
  when: (test_result is failed and test_result.stdout is defined and 'refused' in test_result.stdout)
