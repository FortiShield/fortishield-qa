# REQUIRED VARIABLES
# -------------------
# (String) os: Target operating system

- name: Get Wazuh installation
  include_role:
    name: service_controller
    tasks_from: get_installation_type

- name: Test connection with Wazuh Indexer
  shell: nc -v -4 {{ hostvars[inventory_hostname]['ansible_host'] }} 9200
  timeout: 3
  ignore_errors: true
  register: test_result
  delegate_to: localhost
  when: (os == 'linux' and 'server' in wazuh_info.stdout)

- name: Check the connection between Controller node and Wazuh Indexer
  set_fact:
    check_result: 'true'
    errors: "{{ errors }}Ansible Controller node cannot connect correctly with Wazuh Indexer.\n"
  when: (test_result is failed and test_result.stderr is defined and 'refused' in test_result.stderr)

- name: Test Wazuh Indexer credentials
  uri:
    url: https://{{ hostvars[inventory_hostname]['ansible_host'] }}:9200
    user: "{{ hostvars[inventory_hostname]['dashboard_user'] }}"
    password: "{{ hostvars[inventory_hostname]['dashboard_password'] }}"
    method: GET
    status_code: 200
    force_basic_auth: true
    return_content: true
    validate_certs: false
  ignore_errors: true
  register: api_response
  delegate_to: localhost
  when: (os == 'linux' and 'server' in wazuh_info.stdout)

- name: Check the Wazuh Indexer API response
  set_fact:
    check_result: 'true'
    errors: "{{ errors }}The Wazuh Indexer credentials are invalid, please check the inventory.\n"
  when: (os == 'linux' and 'server' in wazuh_info.stdout and 'Unauthorized' in api_response.content)
